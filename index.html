<!DOCTYPE html>
<html>

<head>
	<meta charset=utf-8 />
	<title>Language and Autism</title>
	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
	<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.css' rel='stylesheet' />
	<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.Default.css' rel='stylesheet' />

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" />

	<link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet' type='text/css'>
	<script src='https://code.jquery.com/jquery-1.12.0.min.js'></script>
	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
	<script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js'></script>
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

	<link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" type="text/css">
	<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>

	<script src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
	<script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
	<script src="http://cdn.oesmith.co.uk/morris-0.4.1.min.js"></script>
	<style>
		.mycluster {
			width: 40px;
			height: 40px;
			background-color: #3498db;
			text-align: center;
			font-size: 18px;
			border-radius: 50%;
			border: 2px #0B486B;
			color: whitesmoke;
			weight: 1;
			line-height: 40px;
			-webkit-box-shadow: 2px 2px 5px 0px rgba(0, 0, 0, 1);
			-moz-box-shadow: 2px 2px 5px 0px rgba(0, 0, 0, 1);
			box-shadow: 2px 2px 5px 0px rgba(0, 0, 0, 1);
		}
		
		body {
			margin: 0;
			padding: 0;
			font-family: "Montserrat"
		}
		
		#map {
			position: absolute;
			top: 0;
			height: 100%;
			width: 100%;
			left: 0px;
			z-index: 1;
		}
		
		p {
			padding: 0px 0px 0px 0px;
			font-size: .8em
		}
		
		h1 {
			padding: 8px 25px 8px 15px;
			margin: 0;
			background: #0B486B;
			color: "whitesmoke";
			font-weight: 400;
			font-size: 1.5em;
			text-align: left;
			font-family: Montserrat;
		}
		
		h2 {
			margin: 0;
			padding: 8px 0px 8px 0px;
			color: #0B486B;
			font-weight: 500;
			font-size: 1.3em;
			text-align: center;
			font-family: Montserrat;
			font-weight: bold
		}
		
		h3 {
			margin: 0;
			padding: 5px 0px 0px 0px;
			color: #0B486B;
			font-weight: 500;
			font-size: 1.3em;
			text-align: left;
			font-family: Montserrat;
			font-weight: bold
		}
		
		h4 {
			margin: 0;
			padding: 2px 2px 2px 2px;
			color: #0B486B;
			font-weight: 500;
			font-size: 1.3em;
			text-align: center;
			font-family: Montserrat;
			font-weight: bold
		}
		
		h5 {
			margin: 0;
			padding: 0px 0px 0px 0px;
			color: #0B486B;
			font-size: 1em;
			text-align: left;
			font-family: Montserrat;
			font-weight: bold
		}
		
		h6 {
			margin: 0;
			padding: 0px 0px 0px 0px;
			color: #0B486B;
			font-size: 1em;
			text-align: right;
			font-family: Montserrat;
			font-weight: bold
		}
		
		.container {
			left: 20px;
			width: 255px;
			top: 15px;
			padding: 5px 5px 8px 5px;
			background: #ecf0f1;
			opacity: .95;
			border: 2px solid #0B486B;
			z-index: 5;
			position: absolute;
			border-radius: 5px;
		}
		
		.adultsparks {
			width: 1005px;
			height: 110px;
			padding: 2px 2px 2px 2px;
			background: #ecf0f1;
			opacity: .95;
			border: 2px solid #0B486B;
			z-index: 5;
			border-radius: 5px;
			/*            overflow-x: scroll;*/
		}
		
		.square {
			display: block;
			border-radius: 50%;
			float: right;
			height: 20px;
			width: 20px;
			text-align: center;
			margin-right: 10px;
			color: #0B486B;
			padding: 0px 0px 0px 0px;
		}
		
		#legend {
			position: absolute;
			right: 15px;
			height: 145px;
			bottom: 15px;
			padding: 4px 4px 4px 4px;
			background: #ecf0f1;
			opacity: .95;
			border: 2px solid #0B486B;
			border-radius: 5px;
			width: 154px;
			opacity: .9;
			z-index: 7;
			color: #0B486B;
			text-align: center
		}
		
		.clusterIcon {
			display: block;
			border-radius: 50%;
			float: right;
			height: 40px;
			width: 40px;
			text-align: right;
			color: #3498db;
			margin-right: 10px;
			border: #0B486B;
			-webkit-box-shadow: 2px 2px 5px 0px rgba(0, 0, 0, 1);
			-moz-box-shadow: 2px 2px 5px 0px rgba(0, 0, 0, 1);
			box-shadow: 2px 2px 5px 0px rgba(0, 0, 0, 1);
			padding: 0px 0px 0px 0px
		}
		
		ref {
			width: 40px;
			height: 40px;
			text-align: center;
			font-size: 18px;
			color: whitesmoke;
			weight: 1;
			line-height: 40px;
		}
		
		.btn {
			padding: 10px 80px;
			margin: 5px;
			border: 0 none;
			font-weight: 700;
			letter-spacing: 1px;
			float: inherit;
			background: #3498db;
		}
		
		#sparks {
			position: fixed;
			left: 20px;
			right: 0px;
			bottom: 15px;
			z-index: 4;
		}
		
		.info h3 {
			margin: 0;
			font-size: 2em;
		}
		
		.jqstooltip {
			-webkit-box-sizing: content-box;
			-moz-box-sizing: content-box;
			box-sizing: content-box;
		}
		
		#leaflet-slider {
			color: snow;
			width: 500px;
			height: 20px;
			font-size: 2em;
			position: absolute;
			left: 425px;
			bottom: 150px;
			background: #0B486B
		}
		
		#slider-timestamp {
			background: #3498db
		}
		
		.info {
			padding: 6px 8px;
			font: 14px/16px Arial, Helvetica, sans-serif;
			background: #ecf0f1;
			background: rgba (255, 255, 255, 0.8);
			box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
			border-radius: 5px;
			border: 2px solid #0B486B;
		}
		
		.info h4 {
			margin: 0 0 5px;
			color: #0B486B;
		}
		
		.donut {
			z-index: 12;
			position: absolute;
			bottom: 155px;
			right: 5px;
			width: 175px;
			height: 175px;
		}
	</style>
</head>


<body>

	<script src="sparkline.js"></script>
	<script src="SliderControl.js"></script>
	<script src="B_winter_interval.js"></script>

	<div id="donut-example" class="donut"></div>

	<div id='about-button' class="container">
		<h2>Language and Autism</h2>
		<button type="button" class="btn btn-info" data-toggle="collapse" data-target="#demo"> <span>The Map</span>
		</button>
		<!--
		<button type="button" class="btn btn-info" data-toggle="collapse" data-target="#info2"> <span>The Data</span>
		</button>
-->

		<div id="info2" class="collapse">
			<p>About the Data: </p>
			<p>This data is the product of a research effort at the University of Kentucky led by Dwight Irvin, PhD, Joanne Rojas, PhD, and Ying Luo, PhD.</p>
		</div>

		<div id="demo" class="collapse">
			<p>About this Map:</p>
			<p>Rich language environments are crucial in language and social communication development for children with autism spectrum disorder (ASD). Childrenâ€™s participation in community activities and adult vocalizations received while in the community are particularly effective in positively impacting development. This map visualizes languge a child with Autism experiences throughout a typical day with her family. This data is the product of a research effort at the University of Kentucky led by Dwight Irvin, PhD, Joanne Rojas, PhD, and Ying Luo, PhD. Map authored by: <a href="http://annaleebard.github.io/">Anna Bard</a>
			</p>
		</div>
	</div>


	<div id="legend">

		<p class="one"><span class="square" style='background:#16A085;'></span>
			<label> Adult Vocalizations </br> per minute</label>
		</p>
		<p class="two"><span class="square" style='background:#EC644B;'></span>
			<label> Child Vocalizations</br> per minute</label>
		</p>
		<p class="three"><span class="clusterIcon" style='background:#3498db;'></span>
			<label> Total #</br> Vocalizations</p>
		</label>
		</p>
	</div>

	<div id=sparks class=adultsparks>
		<span id="sparkline"></span>
		<h5 style="float: left">11:30 AM</h5>
		<h6 style="float: right">3:30 PM</h6>
		<h4> Vocalizations per Minute</h4>

	</div>

	<div id='map'></div>

	<script>
		var map = L.map('map', {
			center: [28.71, -81.30],
			zoom: 13,
			maxZoom: 25,
			zoomControl: false
		})

		var tiles = L.tileLayer('http://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.{ext}', {
			attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
			subdomains: 'abcd',
			minZoom: 0,
			maxZoom: 25,
			ext: 'png'
		});
		tiles.addTo(map);
		map.addLayer(tiles);

		var sliderControl = null;

		//		
		//		
		//		
		//		var commonStyles = {
		//			weight: 1,
		//			stroke: 1,
		//			fillOpacity: .8
		//		}
		//
		//		var layerInfo = {
		//			adultLayer: {
		//				source: "adult",
		//				color: '#1f78b4'
		//			},
		//			peerLayer: {
		//				source: "peer",
		//				color: '#a6cee3'
		//			},
		//			childLayer: {
		//				source: "child",
		//				color: '#fff89e'
		//			}
		//		};
		//
		//		var radiusCircle = L.circle([0, 0], 500000, {
		//			fillColor: false,
		//			fillOpacity: .2,
		//			stroke: false,
		//			weight: 2,
		//		}).addTo(map);
		//
		//		var geoJsonLayers = {};
		//
		//		for (var layer in layerInfo) {
		//			geoJsonLayers[layer] = L.geoJson(vocalInterval, {
		//				pointToLayer: function (feature, latlng) {
		//					return L.circleMarker(latlng, commonStyles);
		//				},
		//				filter: function (feature) {
		//					if (feature.properties[layerInfo[layer].source]) {
		//						return feature;
		//					}
		//				},
		//				style: function (feature) {
		//					return {
		//						color: layerInfo[layer].color,
		//						fillColor: layerInfo[layer].color,
		//						radius: getRadius(feature.properties[layerInfo[layer].source])
		//					}
		//				}
		//				
		//			}).addTo(map);
		//			//add slider control for adult layer
		//			sliderControl = L.control.sliderControl({
		//				position: "topleft",
		//				layer: layer,
		//			});
		//
		//			sliderControl = L.control.sliderControl({
		//				position: "bottomleft",
		//				layer: layer,
		//				timeAttribute: "time",
		//				range: true
		//			});
		//			//Make sure to add the slider to the map ;-)
		//			map.addControl(sliderControl);
		//			//And initialize the slider
		//			sliderControl.startSlider();
		//		}
		//		
		//		function getRadius(val) {
		//			var radius = Math.sqrt(val / Math.PI);
		//			return radius * 20;
		//		}


		//
		$.getJSON("B_winter_interval.geojson", function (json) {
			drawMap(json);
			processData(json);
		});

		function drawMap(circleData) {

			//create circle markers with style for adult vocalizations 
			var adult = L.geoJson(circleData, {
				pointToLayer: function (feature, latlng) {
					return L.circleMarker(latlng, {
						color: '#16A085',
						fillcolor: '#16A085',
						opacity: 1,
						weight: 1.5,
						fillOpacity: .5,
					});
				}
			}).addTo(map);

			//create circle markers with style for child vocalizations
			var child = L.geoJson(circleData, {
				pointToLayer: function (feature, latlng) {
					return L.circleMarker(latlng, {
						color: '#EC644B',
						fillColor: '#EC644B',
						opacity: 1,
						weight: 1.5,
						fillOpacity: .5,
					});
				}
			}).addTo(map);
			updateSymbols(adult, child, 1);


		};

		function updateSymbols(adult, child) {

			var allRadii = [];
			var radius;
			adult.eachLayer(function (layer) {
				layer.bindPopup('Adult Vocalizations: ' + layer.feature.properties.adult);
				radius = calcRadius(layer.feature.properties.adult);
				layer.setRadius(radius)
				allRadii.push(radius)
			});

			child.eachLayer(function (layer) {
				layer.bindPopup('Child Vocalizations: ' + layer.feature.properties.child);
				radius = calcRadius(layer.feature.properties.child);
				layer.setRadius(radius)
				allRadii.push(radius)
			});
		}

		function calcRadius(val) {
			var radius = Math.sqrt(val / Math.PI);
			return radius * 8;
		}

		// use JQuery to load GeoJSON from an external file
		$.getJSON("B_winter_park_clean.geojson", function (data) {
			// add GeoJSON layer to the map once the file is loaded
			//			console.log(data);

			dataLayer = L.geoJson(data, {
				pointToLayer: function (feature, latlng) {
					return L.circleMarker(latlng, {
						color: '#16A085',
						radius: 3,
						fillColor: "#0B486B",
						fillOpacity: .8,
						minZoom: 5,
						stroke: 0,
					})
				}
			});

			//create clusters
			var clusters = L.markerClusterGroup({
				maxClusterRadius: 120,
				//create custom icon
				iconCreateFunction: function (cluster) {

					var markers = cluster.getAllChildMarkers();
					var n = 0;
					for (var i = 0; i < markers.length; i++) {
						n = markers.length;
					}
					return L.divIcon({
						html: n,
						className: 'mycluster',
						iconSize: (40)
					});
				},

				//Disable all of the defaults:
				spiderfyOnMaxZoom: false,
				showCoverageOnHover: true,
				zoomToBoundsOnClick: true,
				polygonOptions: {
					color: '#f1c40f',
					stroke: 1,
					fillOpacity: .7,
				}
			});
			clusters.addLayer(dataLayer);
			map.addLayer(clusters);
			buildInfo(clusters);
		});

		function buildInfo(clusters, dataLayer) {
			clusters.on('clustermouseover', function (a) {
				var markers = a.layer.getAllChildMarkers();

				// variables to hold our count
				var adult = 0,
					child = 0,
					peer = 0,
					convoTurn = 0,
					ratio = 0;

				// loop through and add up the counts 
				for (var i = 0; i < markers.length; i++) {
					adult += markers[i].feature.properties['adult'];
					child += markers[i].feature.properties['child'];
					peer += markers[i].feature.properties['peer'];
					convoTurn += markers[i].feature.properties['convoTurn'];
					ratio = child / adult
				}

				// build html for info panel
				var html =
					'Adult: ' + adult + '<br>' +
					'Child: ' + child + '<br>' +
					'Peer:  ' + peer + '<br>' +
					'Conversation Turns:  ' + convoTurn + '<br>' +
					'Child to Adult Vocalization Ratio: ' + ratio.toLocaleString();

				var info = L.control();

				info.onAdd = function (map) {
					this._div = L.DomUtil.create('div', 'info');
					this.update();
					return this._div;
				};
				info.update = function (props) {
					this._div.innerHTML = '<h4>Language Data: </h4>' + html
				};
				info.addTo(map);
			});

			clusters.on('clustermouseout', function () {
				$(".info").hide();

			});
		};

		function processData(json, circleData) {
			//create empty array to push values into
			var adultValueArray = []
			var childValueArray = []
			var timeValueArray = []
			var peerValueArray = []





			//loop through json and push adult and child values to array
			for (var adultValue in json.features) {
				var adultProp = json.features[adultValue].properties.adult;

				adultValueArray.push(adultProp)
			}
			console.log(adultValueArray);

			for (var childValue in json.features) {
				var childProp = json.features[childValue].properties.child;

				childValueArray.push(childProp)
			}
			//console.log(childValueArray);


			for (var timeValue in json.features) {
				var timeProp = json.features[timeValue].properties.time;

				timeValueArray.push(timeProp)
			}
			
			for (var peerValue in json.features) {
				var peerProp = json.features[peerValue].properties.peer;

				peerValueArray.push(peerProp)
			}
			//console.log(timeValueArray);


			var adultSum = adultValueArray.reduce(function (a, b) {
				return a + b;
			}, 0);
			console.log(adultSum);
			var childSum = childValueArray.reduce(function (a, b) {
				return a + b;
			}, 0);
			console.log(childSum);
			var peerSum = peerValueArray.reduce(function (a, b) {
				return a + b;
			}, 0);
			console.log(peerSum);

			// Values to render
			//		var adultValueArray = [21, 19, 15, 15, 10, 18, 16, 25, 19, 48, 53, 22, 30, 27, 28, 47, 18, 5, 7, 17, 2, 24, 27, 28, 2, 14, 23, 4, 5, 4, 6, 3, 10, 16, 0, 4, 2, 4, 16, 29, 34, 30, 36, 33, 24, 20, 2, 6, 5, 7, 8, 6, 5, 1, 14, 6, 9, 9, 4, 13, 8, 2, 0, 4, 8, 10, 3, 12, 14, 4, 1, 0, 0, 0, 1, 0, 1, 0, 8, 2, 4, 14, 8, 5, 7, 0, 4, 4, 1, 7, 9, 3, 7, 16, 8, 29, 3, 3, 1, 4, 7, 11, 0, 4, 0, 0, 2, 0, 7, 10, 0, 0, 1, 3, 4, 20, 1, 2, 2, 4, 0, 2, 2, 10, 20, 11, 5, 0, 0, 2, 0, 3, 17, 5, 7, 11, 5, 12, 10, 9, 16, 19, 36, 6, 21, 23, 16, 16, 30, 10, 17, 8, 10, 5, 5, 14, 15, 12, 9, 22, 19, 9, 29, 32, 37, 8, 35, 32, 16, 21, 17, 37, 51, 33, 20, 17, 24, 27, 46, 46, 39, 34, 10, 0, 5, 3, 2, 2, 8, 9, 1, 1, 0, 0, 0, 0, 2, 0, 0, 0, 2, 4, 4, 10, 1, 1, 1
			//];

			$('#sparkline').sparkline(adultValueArray, {
				type: "line",
				lineColor: '#16A085',
				width: '1000px',

				height: '80px',
				minSpotColor: false,
				maxSpotColor: '#f1c40f',
				spotColor: '#f1c40f',
				fillColor: false,
				spotRadius: 4,
				lineWidth: 3,
				chartRangeMin: 0,
				chartRangeMax: 53,
				highlightLineColor: '#f1c40f'
			});

			// Draw a sparkline for the #sparkline element
			$('#sparkline').sparkline(childValueArray, {
				type: "line",
				composite: true,
				width: '1000px',
				height: '80px',
				minSpotColor: false,
				maxSpotColor: '#f1c40f',
				fillColor: false,
				lineColor: '#e74c3c',
				spotRadius: 4,
				lineWidth: 3,
				highlightLineColor: '#f1c40f',
				chartRangeMin: 0,
				chartRangeMax: 53
			});

		}

		Morris.Donut({
			element: 'donut-example',
			data: [
				{
					label: "Total Adult",
					value: 2386
				},
				{
					label: "Total Child",
					value: 756
				},
				{
					label: "Total Peer",
					value: 142
				}
  ],
			labelColor: '#0B486B',
			colors: [
        '#16A085',
        '#e74c3c',
        '#f1c40f'
    ],
		});
	</script>
</body>

</html>